<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task 11.2: Analyze Results and Implement Fixes - Oriel Signal FX Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #4a5568;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .task-info {
            background: #e6fffa;
            border: 2px solid #38b2ac;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .task-info h3 {
            color: #2c7a7b;
            margin-bottom: 10px;
        }

        .task-info ul {
            color: #2d3748;
            margin-left: 20px;
        }

        .execution-status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            border-radius: 25px;
            background: #e2e8f0;
            color: #4a5568;
            font-weight: 600;
        }

        .execution-status.running {
            background: #fed7d7;
            color: #c53030;
        }

        .execution-status.completed {
            background: #c6f6d5;
            color: #2d7d32;
        }

        .execution-status.failed {
            background: #fed7d7;
            color: #c53030;
        }

        .main-controls {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #38b2ac 0%, #319795 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            color: white;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .phases-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .phase-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .phase-card.active {
            border-color: #f6ad55;
            background: #fffaf0;
        }

        .phase-card.completed {
            border-color: #68d391;
            background: #f0fff4;
        }

        .phase-card.failed {
            border-color: #fc8181;
            background: #fff5f5;
        }

        .phase-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .phase-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #4a5568;
        }

        .phase-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .phase-status.pending {
            background: #e2e8f0;
            color: #718096;
        }

        .phase-status.running {
            background: #fed7d7;
            color: #c53030;
        }

        .phase-status.completed {
            background: #c6f6d5;
            color: #2d7d32;
        }

        .phase-status.failed {
            background: #fed7d7;
            color: #c53030;
        }

        .phase-description {
            color: #718096;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .phase-progress {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .phase-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78, #38a169);
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .phase-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #718096;
        }

        .results-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 2px solid #e2e8f0;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #718096;
            font-size: 0.9rem;
        }

        .stat-card.patterns .stat-number {
            color: #667eea;
        }

        .stat-card.fixes .stat-number {
            color: #38a169;
        }

        .stat-card.improvement .stat-number {
            color: #d69e2e;
        }

        .stat-card.success .stat-number {
            color: #38a169;
        }

        .logs-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .logs-container {
            background: #1a202c;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-entry.error {
            color: #fc8181;
        }

        .log-entry.warning {
            color: #f6e05e;
        }

        .log-entry.success {
            color: #68d391;
        }

        .log-entry.info {
            color: #63b3ed;
        }

        .patterns-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .pattern-item {
            background: #f7fafc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .pattern-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .pattern-name {
            font-weight: 600;
            color: #4a5568;
        }

        .pattern-count {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .pattern-description {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .pattern-suites {
            font-size: 0.8rem;
            color: #a0aec0;
        }

        @media (max-width: 768px) {
            .phases-grid {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Task 11.2: Analyze Results and Implement Fixes</h1>
            <p>Analyze test results, identify failure patterns, implement fixes, and validate improvements</p>
            
            <div class="task-info">
                <h3>üìã Task Requirements</h3>
                <ul>
                    <li>Analyze test results and identify failure patterns</li>
                    <li>Implement fixes for identified issues and bugs</li>
                    <li>Re-run tests to validate fixes and improvements</li>
                    <li>Requirements: 8.3, 9.1, 10.3, 10.4</li>
                </ul>
            </div>
            
            <div id="execution-status" class="execution-status">
                <span>‚è∏Ô∏è</span>
                <span>Ready to Execute</span>
            </div>
        </div>

        <div class="main-controls">
            <button id="execute-task-btn" class="btn btn-primary">
                üöÄ Execute Task 11.2
            </button>
            <button id="analyze-only-btn" class="btn btn-secondary">
                üîç Analyze Only
            </button>
            <button id="rerun-tests-btn" class="btn btn-warning">
                üîÑ Re-run Tests
            </button>
        </div>

        <div class="phases-grid" id="phases-grid">
            <!-- Phases will be populated here -->
        </div>

        <div class="results-section">
            <h2>üìä Analysis Results</h2>
            <div class="results-grid">
                <div class="stat-card patterns">
                    <div id="patterns-count" class="stat-number">0</div>
                    <div class="stat-label">Patterns Identified</div>
                </div>
                <div class="stat-card fixes">
                    <div id="fixes-count" class="stat-number">0</div>
                    <div class="stat-label">Fixes Implemented</div>
                </div>
                <div class="stat-card improvement">
                    <div id="improvement-rate" class="stat-number">0%</div>
                    <div class="stat-label">Improvement Rate</div>
                </div>
                <div class="stat-card success">
                    <div id="final-success-rate" class="stat-number">0%</div>
                    <div class="stat-label">Final Success Rate</div>
                </div>
            </div>
        </div>

        <div class="patterns-section" id="patterns-section" style="display: none;">
            <h2>üîç Identified Failure Patterns</h2>
            <div id="patterns-list">
                <!-- Patterns will be populated here -->
            </div>
        </div>

        <div class="logs-section">
            <h2>üìù Execution Logs</h2>
            <div id="logs-container" class="logs-container">
                <div class="log-entry info">[00:00:00] Task 11.2 Analysis and Fixes system initialized and ready</div>
            </div>
        </div>
    </div>

    <!-- Load all required dependencies -->
    <script src="app-config.js"></script>
    <script src="api-client.js"></script>
    <script src="notification-manager.js"></script>
    <script src="auth-manager.js"></script>
    <script src="auth-ui.js"></script>
    <script src="enhanced-logger.js"></script>
    <script src="download-modal.js"></script>
    
    <!-- Load test modules -->
    <script src="registration-flow-tests.js"></script>
    <script src="login-flow-tests.js"></script>
    <script src="authentication-testing-module.js"></script>
    <script src="download-modal-interception-tests.js"></script>
    <script src="format-specific-download-tests.js"></script>
    <script src="server-startup-tests.js"></script>
    
    <!-- Load comprehensive test execution suite -->
    <script src="comprehensive-test-execution-suite.js"></script>
    
    <!-- Load analysis and fixes module -->
    <script src="test-results-analysis-and-fixes.js"></script>

    <script>
        class Task11_2Runner {
            constructor() {
                this.analyzer = null;
                this.isRunning = false;
                this.currentPhase = null;
                this.startTime = null;
                this.results = null;
                
                this.phases = [
                    {
                        id: 'analysis',
                        name: 'Results Analysis',
                        description: 'Analyze test results and identify failure patterns',
                        status: 'pending'
                    },
                    {
                        id: 'fixes',
                        name: 'Implement Fixes',
                        description: 'Implement automated fixes for identified issues',
                        status: 'pending'
                    },
                    {
                        id: 'validation',
                        name: 'Validate Fixes',
                        description: 'Re-run tests to validate fixes and improvements',
                        status: 'pending'
                    }
                ];
                
                this.initializeUI();
                this.setupEventListeners();
                this.initializeAnalyzer();
            }

            async initializeAnalyzer() {
                try {
                    this.log('üîß Initializing Task 11.2 Analysis and Fixes system...', 'info');
                    
                    // Wait for dependencies
                    await this.waitForDependencies();
                    
                    this.analyzer = new TestResultsAnalysisAndFixes();
                    
                    // Populate phases
                    this.populatePhases();
                    
                    this.log('‚úÖ Task 11.2 system ready for execution', 'success');
                    
                } catch (error) {
                    this.log(`‚ùå Failed to initialize Task 11.2 system: ${error.message}`, 'error');
                }
            }

            async waitForDependencies() {
                const maxWait = 10000; // 10 seconds
                const checkInterval = 100;
                let waited = 0;
                
                const requiredClasses = [
                    'TestResultsAnalysisAndFixes',
                    'ComprehensiveTestExecutionSuite'
                ];
                
                while (waited < maxWait) {
                    const allLoaded = requiredClasses.every(className => window[className]);
                    if (allLoaded) {
                        return;
                    }
                    await new Promise(resolve => setTimeout(resolve, checkInterval));
                    waited += checkInterval;
                }
                
                throw new Error('Required modules not loaded within timeout');
            }

            initializeUI() {
                this.elements = {
                    executionStatus: document.getElementById('execution-status'),
                    phasesGrid: document.getElementById('phases-grid'),
                    executeTaskBtn: document.getElementById('execute-task-btn'),
                    analyzeOnlyBtn: document.getElementById('analyze-only-btn'),
                    rerunTestsBtn: document.getElementById('rerun-tests-btn'),
                    patternsCount: document.getElementById('patterns-count'),
                    fixesCount: document.getElementById('fixes-count'),
                    improvementRate: document.getElementById('improvement-rate'),
                    finalSuccessRate: document.getElementById('final-success-rate'),
                    patternsSection: document.getElementById('patterns-section'),
                    patternsList: document.getElementById('patterns-list'),
                    logsContainer: document.getElementById('logs-container')
                };
            }

            setupEventListeners() {
                this.elements.executeTaskBtn.addEventListener('click', () => this.executeCompleteTask());
                this.elements.analyzeOnlyBtn.addEventListener('click', () => this.executeAnalysisOnly());
                this.elements.rerunTestsBtn.addEventListener('click', () => this.rerunTestsOnly());
            }

            populatePhases() {
                this.elements.phasesGrid.innerHTML = '';
                
                this.phases.forEach(phase => {
                    const phaseCard = document.createElement('div');
                    phaseCard.className = 'phase-card';
                    phaseCard.id = `phase-${phase.id}`;
                    
                    phaseCard.innerHTML = `
                        <div class="phase-header">
                            <div class="phase-name">${phase.name}</div>
                            <div class="phase-status pending">Pending</div>
                        </div>
                        <div class="phase-description">${phase.description}</div>
                        <div class="phase-progress">
                            <div class="phase-progress-fill" style="width: 0%"></div>
                        </div>
                        <div class="phase-stats">
                            <span>Status: <span class="status-text">Waiting</span></span>
                            <span>Duration: <span class="duration-text">0ms</span></span>
                        </div>
                    `;
                    
                    this.elements.phasesGrid.appendChild(phaseCard);
                });
            }

            async executeCompleteTask() {
                if (this.isRunning) return;
                
                try {
                    this.isRunning = true;
                    this.startTime = Date.now();
                    this.updateExecutionStatus('running', 'Executing Task 11.2...');
                    this.disableButtons();
                    
                    this.log('üöÄ Starting Task 11.2: Analyze results and implement fixes', 'info');
                    
                    // Execute complete task
                    this.results = await this.analyzer.executeTask11_2();
                    
                    // Update UI with results
                    this.displayResults(this.results);
                    
                    const duration = Date.now() - this.startTime;
                    this.updateExecutionStatus('completed', 'Task 11.2 Completed');
                    this.log(`üéâ Task 11.2 completed successfully in ${duration}ms`, 'success');
                    
                } catch (error) {
                    this.log(`‚ùå Task 11.2 execution failed: ${error.message}`, 'error');
                    this.updateExecutionStatus('failed', 'Task 11.2 Failed');
                } finally {
                    this.isRunning = false;
                    this.enableButtons();
                }
            }

            async executeAnalysisOnly() {
                if (this.isRunning) return;
                
                try {
                    this.isRunning = true;
                    this.updateExecutionStatus('running', 'Analyzing Results...');
                    this.disableButtons();
                    
                    this.log('üîç Starting analysis phase only...', 'info');
                    
                    // Update phase status
                    this.updatePhaseStatus('analysis', 'running');
                    
                    // Execute analysis
                    const analysisReport = await this.analyzer.analyzeTestResults();
                    
                    // Update UI
                    this.displayAnalysisResults(analysisReport);
                    this.updatePhaseStatus('analysis', 'completed');
                    
                    this.updateExecutionStatus('completed', 'Analysis Completed');
                    this.log('‚úÖ Analysis phase completed', 'success');
                    
                } catch (error) {
                    this.log(`‚ùå Analysis failed: ${error.message}`, 'error');
                    this.updatePhaseStatus('analysis', 'failed');
                    this.updateExecutionStatus('failed', 'Analysis Failed');
                } finally {
                    this.isRunning = false;
                    this.enableButtons();
                }
            }

            async rerunTestsOnly() {
                if (this.isRunning) return;
                
                try {
                    this.isRunning = true;
                    this.updateExecutionStatus('running', 'Re-running Tests...');
                    this.disableButtons();
                    
                    this.log('üîÑ Re-running tests for validation...', 'info');
                    
                    // Check if we have previous analysis and fixes
                    const storedAnalysis = localStorage.getItem('test_results_analysis');
                    const storedFixes = localStorage.getItem('implemented_fixes');
                    
                    if (!storedAnalysis || !storedFixes) {
                        throw new Error('No previous analysis or fixes found. Run complete task first.');
                    }
                    
                    const analysisReport = JSON.parse(storedAnalysis)[0]; // Get latest analysis
                    const implementedFixes = JSON.parse(storedFixes);
                    
                    // Update phase status
                    this.updatePhaseStatus('validation', 'running');
                    
                    // Re-run tests
                    const validationResults = await this.analyzer.rerunTestsToValidateFixes(analysisReport, implementedFixes);
                    
                    // Update UI
                    this.displayValidationResults(validationResults);
                    this.updatePhaseStatus('validation', 'completed');
                    
                    this.updateExecutionStatus('completed', 'Validation Completed');
                    this.log('‚úÖ Test validation completed', 'success');
                    
                } catch (error) {
                    this.log(`‚ùå Test validation failed: ${error.message}`, 'error');
                    this.updatePhaseStatus('validation', 'failed');
                    this.updateExecutionStatus('failed', 'Validation Failed');
                } finally {
                    this.isRunning = false;
                    this.enableButtons();
                }
            }

            updateExecutionStatus(status, message) {
                this.elements.executionStatus.className = `execution-status ${status}`;
                
                const icons = {
                    ready: '‚è∏Ô∏è',
                    running: '‚ñ∂Ô∏è',
                    completed: '‚úÖ',
                    failed: '‚ùå'
                };
                
                this.elements.executionStatus.innerHTML = `
                    <span>${icons[status] || '‚è∏Ô∏è'}</span>
                    <span>${message}</span>
                `;
            }

            updatePhaseStatus(phaseId, status) {
                const phaseCard = document.getElementById(`phase-${phaseId}`);
                if (phaseCard) {
                    phaseCard.className = `phase-card ${status}`;
                    
                    const statusElement = phaseCard.querySelector('.phase-status');
                    statusElement.className = `phase-status ${status}`;
                    statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                    
                    const statusText = phaseCard.querySelector('.status-text');
                    statusText.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                    
                    if (status === 'running') {
                        const progressFill = phaseCard.querySelector('.phase-progress-fill');
                        progressFill.style.width = '50%';
                    } else if (status === 'completed') {
                        const progressFill = phaseCard.querySelector('.phase-progress-fill');
                        progressFill.style.width = '100%';
                    }
                }
            }

            displayResults(results) {
                if (!results) return;
                
                // Update statistics
                if (results.analysis) {
                    this.elements.patternsCount.textContent = results.analysis.identifiedPatterns || 0;
                }
                
                if (results.fixes) {
                    this.elements.fixesCount.textContent = results.fixes.successful || 0;
                }
                
                if (results.validation) {
                    this.elements.improvementRate.textContent = `${(results.validation.overallImprovement || 0).toFixed(1)}%`;
                    this.elements.finalSuccessRate.textContent = `${(results.validation.finalSuccessRate || 0).toFixed(1)}%`;
                }
                
                // Display patterns if available
                const storedAnalysis = localStorage.getItem('test_results_analysis');
                if (storedAnalysis) {
                    const analysisData = JSON.parse(storedAnalysis);
                    if (analysisData.length > 0) {
                        this.displayPatterns(analysisData[analysisData.length - 1].patterns);
                    }
                }
            }

            displayAnalysisResults(analysisReport) {
                if (!analysisReport) return;
                
                this.elements.patternsCount.textContent = analysisReport.patterns.length;
                
                // Display patterns
                this.displayPatterns(analysisReport.patterns);
            }

            displayValidationResults(validationResults) {
                if (!validationResults) return;
                
                this.elements.improvementRate.textContent = `${validationResults.improvement.overallImprovement.toFixed(1)}%`;
                this.elements.finalSuccessRate.textContent = `${validationResults.retestReport.summary.successRate.toFixed(1)}%`;
            }

            displayPatterns(patterns) {
                if (!patterns || patterns.length === 0) {
                    this.elements.patternsSection.style.display = 'none';
                    return;
                }
                
                this.elements.patternsSection.style.display = 'block';
                this.elements.patternsList.innerHTML = '';
                
                patterns.forEach(pattern => {
                    const patternItem = document.createElement('div');
                    patternItem.className = 'pattern-item';
                    
                    patternItem.innerHTML = `
                        <div class="pattern-header">
                            <div class="pattern-name">${pattern.pattern.replace('_', ' ').toUpperCase()}</div>
                            <div class="pattern-count">${pattern.occurrences}</div>
                        </div>
                        <div class="pattern-description">
                            ${pattern.knownPattern ? pattern.knownPattern.description : 'Unknown pattern'}
                        </div>
                        <div class="pattern-suites">
                            Affected suites: ${pattern.affectedSuites.join(', ')}
                        </div>
                    `;
                    
                    this.elements.patternsList.appendChild(patternItem);
                });
            }

            disableButtons() {
                this.elements.executeTaskBtn.disabled = true;
                this.elements.analyzeOnlyBtn.disabled = true;
                this.elements.rerunTestsBtn.disabled = true;
            }

            enableButtons() {
                this.elements.executeTaskBtn.disabled = false;
                this.elements.analyzeOnlyBtn.disabled = false;
                this.elements.rerunTestsBtn.disabled = false;
            }

            log(message, level = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${level}`;
                logEntry.textContent = `[${timestamp}] ${message}`;
                
                this.elements.logsContainer.appendChild(logEntry);
                this.elements.logsContainer.scrollTop = this.elements.logsContainer.scrollHeight;
                
                // Also log to console
                console.log(`[Task 11.2] ${message}`);
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new Task11_2Runner();
        });
    </script>
</body>
</html>